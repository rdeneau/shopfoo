# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: "Publish and Deploy to Azure Web App"

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run semantic-release in dry-run mode (no actual release)'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force deploy from the latest existing release'
        required: false
        default: false
        type: boolean

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        with:
          dry_run: ${{ github.event.inputs.dry-run == 'true' }}

      - name: Release output
        if: steps.semantic.outputs.new-release-published == 'true'
        run: |
          echo "New release published: ${{ steps.semantic.outputs.new-release-version }}"
          echo "Release notes: ${{ steps.semantic.outputs.new-release-notes }}"

  build:
    name: Build and Publish
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.release.outputs.new-release-published == 'true' || github.event.inputs.force_deploy == 'true' }}
    permissions:
      contents: read

    steps:
      - name: Get latest release tag
        id: get_latest_release
        if: ${{ github.event.inputs.force_deploy == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const { data: release } = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            core.setOutput('tag_name', release.tag_name);
            console.log(`Latest release tag is ${release.tag_name}`);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Checkout the latest release tag if force_deploy is true, otherwise checkout main (which was updated by semantic-release)
          ref: ${{ github.event.inputs.force_deploy == 'true' && steps.get_latest_release.outputs.tag_name || 'main' }}

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Yarn
        run: npm install -g yarn@1.22.22

      - name: Install .NET Tools
        run: dotnet tool restore

      - name: Build Artifacts
        run: dotnet run Publish

      - name: Publish App
        uses: actions/upload-artifact@v4
        with:
          name: shopfoo-app
          path: publish/app

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [release, build]
    if: ${{ github.event_name == 'workflow_dispatch' && (needs.release.outputs.new-release-published == 'true' || github.event.inputs.force_deploy == 'true') }}
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: shopfoo-app

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_E34F98EFADEB4D339094690B0427161A }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_24D9BF7EB0774B3CA72CD2F68BBEEC4F }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_0999A826398F4DB19AA64097AD693E9F }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'Shopfoo'
          slot-name: 'Production'
          package: .
